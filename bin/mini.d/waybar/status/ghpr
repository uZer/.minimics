#!/usr/bin/env bash
# display opened github pr needing review

set -euo pipefail

# Pretty print command name
COMMAND=${0//\// }
COMMAND=${COMMAND/*mini.d/mini}

#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# To define the github token on your system:
# create a token here: https://github.com/settings/personal-access-tokens
# scopes: fine grained, Metadata: Read-only, Pull requests: Read-only
#
# define GITHUB_TOKEN_WAYBAR with:
# systemctl --user set-environment GITHUB_TOKEN_WAYBAR=ghp_xxxxxxxxxxxxxxxxx

COUNT_PR=$(
  curl -s \
    -H "Authorization: Bearer $GITHUB_TOKEN" \
    -H "Accept: application/vnd.github+json" \
    "https://api.github.com/search/issues?q=is%3Apr+is%3Aopen+-author%3Aapp%2Frenovate+org%3Abill-of-materials+user%3AuZer" | jq '.total_count'
)

if [ "$COUNT_PR" -eq 0 ]; then
  jq -cM <<EOF
  {
    "text": "",
    "tooltip": "",
    "class": "${class:-offline}"
  }
EOF
else
  jq -cM <<EOF
  {
    "text": "ï‚› $COUNT_PR",
    "tooltip": "$COUNT_PR",
    "class": "${class:-offline}"
  }
EOF
fi
